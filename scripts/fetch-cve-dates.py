#!/usr/bin/env python3
"""
Fetch CVE published dates from NVD API and update the database
"""
import psycopg2
import urllib.request
import urllib.parse
import json
import time
import sys
from datetime import datetime

# Database connection
DB_CONFIG = {
    'host': 'localhost',
    'port': 5432,
    'database': 'vulndb',
    'user': 'vulnuser',
    'password': 'vulnpass'
}

# NVD API configuration
NVD_API_BASE = "https://services.nvd.nist.gov/rest/json/cves/2.0"
REQUEST_DELAY = 6  # 6 seconds between requests (NVD rate limit is 5 requests per 30 seconds without API key)

def fetch_cve_details(cve_id):
    """Fetch CVE details from NVD API"""
    try:
        params = urllib.parse.urlencode({'cveId': cve_id})
        url = f"{NVD_API_BASE}?{params}"

        req = urllib.request.Request(url)
        req.add_header('User-Agent', 'vuln-demo/1.0')

        with urllib.request.urlopen(req, timeout=10) as response:
            if response.status == 200:
                data = json.loads(response.read().decode('utf-8'))
                if 'vulnerabilities' in data and len(data['vulnerabilities']) > 0:
                    vuln = data['vulnerabilities'][0]
                    cve_data = vuln.get('cve', {})

                    # Extract published and modified dates
                    published = cve_data.get('published')
                    modified = cve_data.get('lastModified')

                    return {
                        'published_date': published,
                        'modified_date': modified
                    }
            else:
                print(f"  ‚ö†Ô∏è  Error fetching {cve_id}: HTTP {response.status}")
                return None

    except urllib.error.HTTPError as e:
        if e.code == 404:
            print(f"  ‚ö†Ô∏è  CVE {cve_id} not found in NVD")
        else:
            print(f"  ‚ö†Ô∏è  HTTP Error fetching {cve_id}: {e.code}")
        return None
    except Exception as e:
        print(f"  ‚ö†Ô∏è  Exception fetching {cve_id}: {e}")
        return None


def update_vulnerability_dates(conn, cve_id, published_date, modified_date):
    """Update vulnerability records with published and modified dates"""
    cursor = conn.cursor()

    # Convert ISO strings to datetime
    pub_dt = datetime.fromisoformat(published_date.replace('Z', '+00:00')) if published_date else None
    mod_dt = datetime.fromisoformat(modified_date.replace('Z', '+00:00')) if modified_date else None

    # Update all records with this CVE ID
    cursor.execute("""
        UPDATE vulnerabilities
        SET published_date = %s,
            modified_date = %s
        WHERE cve_id = %s
          AND published_date IS NULL
    """, (pub_dt, mod_dt, cve_id))

    updated_count = cursor.rowcount
    conn.commit()
    cursor.close()

    return updated_count


def main():
    print("=" * 60)
    print("Fetching CVE Published Dates from NVD")
    print("=" * 60)
    print()

    # Connect to database
    print("üîå Connecting to database...")
    conn = psycopg2.connect(**DB_CONFIG)
    cursor = conn.cursor()

    # Get all unique CVE IDs that don't have published dates
    print("üìä Finding CVEs without published dates...")
    cursor.execute("""
        SELECT DISTINCT cve_id
        FROM vulnerabilities
        WHERE published_date IS NULL
          AND cve_id LIKE 'CVE-%'
        ORDER BY cve_id
    """)

    cves = [row[0] for row in cursor.fetchall()]
    total_cves = len(cves)

    print(f"‚úì Found {total_cves} CVEs to fetch")
    print()

    if total_cves == 0:
        print("‚úÖ All CVEs already have published dates!")
        cursor.close()
        conn.close()
        return

    # Fetch and update each CVE
    print(f"üîç Fetching CVE details from NVD (this will take ~{(total_cves * REQUEST_DELAY) / 60:.1f} minutes due to rate limits)...")
    print()

    successful = 0
    failed = 0

    for i, cve_id in enumerate(cves, 1):
        print(f"[{i}/{total_cves}] Fetching {cve_id}...")

        # Fetch from NVD
        cve_data = fetch_cve_details(cve_id)

        if cve_data and cve_data.get('published_date'):
            # Update database
            updated = update_vulnerability_dates(
                conn,
                cve_id,
                cve_data['published_date'],
                cve_data['modified_date']
            )
            print(f"  ‚úÖ Updated {updated} records")
            print(f"     Published: {cve_data['published_date']}")
            successful += 1
        else:
            failed += 1

        # Rate limiting - wait between requests
        if i < total_cves:
            time.sleep(REQUEST_DELAY)

    cursor.close()
    conn.close()

    print()
    print("=" * 60)
    print("‚úÖ CVE Date Fetch Complete!")
    print("=" * 60)
    print(f"  Successful: {successful}")
    print(f"  Failed: {failed}")
    print(f"  Total: {total_cves}")
    print()


if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  Interrupted by user")
        sys.exit(1)
    except Exception as e:
        print(f"\n\n‚ùå Error: {e}")
        sys.exit(1)
